#!/usr/bin/env bash
# bin/install_binaries <build-dir> <cache-dir>
# Installs APT packages from Aptfile

set -euo pipefail

BUILD_DIR="${1:?build directory required}"
CACHE_DIR="${2:?cache directory required}"
LP_DIR="$(cd "$(dirname "$0")/.." && pwd)"

# Logging functions
error() {
    echo " !     $*" >&2
    exit 1
}

topic() {
    echo "-----> $*"
}

indent() {
    local c='s/^/       /'
    case "$(uname)" in
        Darwin) sed -l "$c" ;;
        *) sed -u "$c" ;;
    esac
}

# APT directories
APT_CACHE_DIR="${CACHE_DIR}/apt/cache"
APT_STATE_DIR="${CACHE_DIR}/apt/state"
APT_SOURCELIST_DIR="${CACHE_DIR}/apt/sources"
APT_SOURCES="${APT_SOURCELIST_DIR}/sources.list"

# Check if we can reuse cache
if [[ -f "${APT_CACHE_DIR}/Aptfile" ]] && cmp -s "${BUILD_DIR}/Aptfile" "${APT_CACHE_DIR}/Aptfile"; then
    topic "Reusing APT cache"
else
    topic "Detected Aptfile changes, flushing cache"
    rm -rf "${APT_CACHE_DIR}"
    mkdir -p "${APT_CACHE_DIR}/archives/partial"
    mkdir -p "${APT_STATE_DIR}/lists/partial"
    mkdir -p "${APT_SOURCELIST_DIR}"
    cp -f "${BUILD_DIR}/Aptfile" "${APT_CACHE_DIR}/Aptfile"
    cp "/etc/apt/sources.list" "${APT_SOURCES}"

    # Add custom repositories from Aptfile (lines starting with :repo:)
    topic "Adding custom repositories"
    if grep -qs "^:repo:" "${BUILD_DIR}/Aptfile"; then
        grep "^:repo:" "${BUILD_DIR}/Aptfile" | sed 's/^:repo:\(.*\)\s*$/\1/g' >> "${APT_SOURCES}"
    fi
fi

APT_OPTIONS="-o debug::nolocking=true -o dir::cache=${APT_CACHE_DIR} -o dir::state=${APT_STATE_DIR}"
APT_OPTIONS="${APT_OPTIONS} -o dir::etc::sourcelist=${APT_SOURCES}"

topic "Updating apt caches"
# shellcheck disable=SC2086
apt-get ${APT_OPTIONS} update 2>&1 | indent

# Install packages
while IFS= read -r PACKAGE || [[ -n "$PACKAGE" ]]; do
    # Skip empty lines and repo definitions
    [[ -z "$PACKAGE" || "$PACKAGE" == :repo:* ]] && continue

    if [[ "$PACKAGE" == *.deb ]]; then
        PACKAGE_NAME="$(basename "$PACKAGE" .deb)"
        PACKAGE_FILE="${APT_CACHE_DIR}/archives/${PACKAGE_NAME}.deb"

        topic "Fetching $PACKAGE"
        curl -s -L -z "$PACKAGE_FILE" -o "$PACKAGE_FILE" "$PACKAGE" 2>&1 | indent
    else
        topic "Fetching .debs for $PACKAGE"
        # shellcheck disable=SC2086
        apt-get ${APT_OPTIONS} -y --force-yes -d install --reinstall "$PACKAGE" 2>&1 | indent
    fi
done < "${BUILD_DIR}/Aptfile"

mkdir -p "${BUILD_DIR}/.apt"

# Install all downloaded .deb files
for DEB in "${APT_CACHE_DIR}"/archives/*.deb; do
    [[ -f "$DEB" ]] || continue
    topic "Installing $(basename "$DEB")"
    dpkg -x "$DEB" "${BUILD_DIR}/.apt/"
done

topic "Writing profile script"
mkdir -p "${BUILD_DIR}/.profile.d"
cat <<'EOF' > "${BUILD_DIR}/.profile.d/000_apt.sh"
export PATH="$HOME/.apt/usr/bin:$PATH"
export LD_LIBRARY_PATH="$HOME/.apt/usr/lib/x86_64-linux-gnu:$HOME/.apt/usr/lib/i386-linux-gnu:$HOME/.apt/usr/lib:${LD_LIBRARY_PATH:-}"
export LIBRARY_PATH="$HOME/.apt/usr/lib/x86_64-linux-gnu:$HOME/.apt/usr/lib/i386-linux-gnu:$HOME/.apt/usr/lib:${LIBRARY_PATH:-}"
export INCLUDE_PATH="$HOME/.apt/usr/include:$HOME/.apt/usr/include/x86_64-linux-gnu:${INCLUDE_PATH:-}"
export CPATH="$INCLUDE_PATH"
export CPPPATH="$INCLUDE_PATH"
export PKG_CONFIG_PATH="$HOME/.apt/usr/lib/x86_64-linux-gnu/pkgconfig:$HOME/.apt/usr/lib/i386-linux-gnu/pkgconfig:$HOME/.apt/usr/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
EOF

# Export for current build
export PATH="${BUILD_DIR}/.apt/usr/bin:$PATH"
export LD_LIBRARY_PATH="${BUILD_DIR}/.apt/usr/lib/x86_64-linux-gnu:${BUILD_DIR}/.apt/usr/lib/i386-linux-gnu:${BUILD_DIR}/.apt/usr/lib:${LD_LIBRARY_PATH:-}"
export LIBRARY_PATH="${BUILD_DIR}/.apt/usr/lib/x86_64-linux-gnu:${BUILD_DIR}/.apt/usr/lib/i386-linux-gnu:${BUILD_DIR}/.apt/usr/lib:${LIBRARY_PATH:-}"
export INCLUDE_PATH="${BUILD_DIR}/.apt/usr/include:${BUILD_DIR}/.apt/usr/include/x86_64-linux-gnu:${INCLUDE_PATH:-}"
export CPATH="$INCLUDE_PATH"
export CPPPATH="$INCLUDE_PATH"
export PKG_CONFIG_PATH="${BUILD_DIR}/.apt/usr/lib/x86_64-linux-gnu/pkgconfig:${BUILD_DIR}/.apt/usr/lib/i386-linux-gnu/pkgconfig:${BUILD_DIR}/.apt/usr/lib/pkgconfig:${PKG_CONFIG_PATH:-}"

# Export environment for later buildpacks
{
    echo "export PATH=\"${PATH}\""
    echo "export LD_LIBRARY_PATH=\"${LD_LIBRARY_PATH}\""
    echo "export LIBRARY_PATH=\"${LIBRARY_PATH}\""
    echo "export INCLUDE_PATH=\"${INCLUDE_PATH}\""
    echo "export CPATH=\"${CPATH}\""
    echo "export CPPPATH=\"${CPPPATH}\""
    echo "export PKG_CONFIG_PATH=\"${PKG_CONFIG_PATH}\""
} > "${LP_DIR}/export"

topic "Rewriting package-config files"
find "${BUILD_DIR}/.apt" -type f -ipath '*/pkgconfig/*.pc' -print0 | \
    xargs -0 --no-run-if-empty -n 1 sed -i -e "s!^prefix=\(.*\)\$!prefix=${BUILD_DIR}/.apt\1!g"
