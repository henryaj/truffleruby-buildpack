#!/usr/bin/env bash
# bin/release <build-dir>
# Generates release configuration for the application

set -euo pipefail

BUILD_DIR="${1:?build directory required}"

# Check if app is a Rack application
is_rack_app() {
    local build_dir="${1:?build_dir required}"
    [[ -f "${build_dir}/config.ru" ]]
}

# Check if app is a Rails application
is_rails_app() {
    local build_dir="${1:?build_dir required}"
    [[ -f "${build_dir}/Gemfile" ]] && grep -qE "gem ['\"]railties['\"]" "${build_dir}/Gemfile"
}

# Check if app uses PostgreSQL
has_postgres() {
    local build_dir="${1:?build_dir required}"
    [[ -f "${build_dir}/Gemfile" ]] && grep -qE "gem ['\"]pg['\"]" "${build_dir}/Gemfile"
}

# Output YAML header
echo "---"

# Suggest PostgreSQL addon if pg gem is used
if has_postgres "$BUILD_DIR"; then
    cat <<EOF
addons:
  - heroku-postgresql
EOF
fi

# Generate default process types if no Procfile exists
if [[ ! -f "${BUILD_DIR}/Procfile" ]]; then
    if is_rails_app "$BUILD_DIR"; then
        cat <<'EOF'
default_process_types:
  web: bundle exec rails server -p $PORT -e $RAILS_ENV
  console: bundle exec rails console
EOF
    elif is_rack_app "$BUILD_DIR"; then
        cat <<'EOF'
default_process_types:
  web: bundle exec rackup -p $PORT -E $RACK_ENV
EOF
    else
        cat <<'EOF'
default_process_types:
  rake: bundle exec rake
  console: bundle exec irb
EOF
    fi
fi
