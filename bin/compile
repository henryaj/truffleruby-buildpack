#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>
# Compiles the application for deployment on Heroku

set -euo pipefail

# Get buildpack directory
BP_DIR="$(cd "$(dirname "$0")/.." && pwd)"
BUILD_DIR="${1:?build directory required}"
CACHE_DIR="${2:?cache directory required}"

# shellcheck source=../lib/common.sh
source "${BP_DIR}/lib/common.sh"

# Write Aptfile for system dependencies
log_info "Writing Aptfile for system dependencies"
cat > "$BUILD_DIR/Aptfile" <<EOF
openssl
make
clang
llvm
libssl-dev
git
EOF

# Copy profile scripts
mkdir -p "$BUILD_DIR/.profile.d"
cp "${BP_DIR}/.profile.d/graal_env" "$BUILD_DIR/.profile.d/"

# Install APT packages
log_info "Installing system dependencies via APT"
"${BP_DIR}/bin/install_binaries" "$BUILD_DIR" "$CACHE_DIR"

# Source environment variables from install_binaries script
if [[ -f "${BP_DIR}/export" ]]; then
    # shellcheck source=/dev/null
    source "${BP_DIR}/export"
fi

# Install TruffleRuby to the app directory (persists at runtime)
TRUFFLERUBY_HOME="${BUILD_DIR}/.truffleruby"
install_truffleruby "$TRUFFLERUBY_HOME"

# Install rbenv for Ruby version management
log_info "Installing rbenv"
RBENV_ROOT="${BUILD_DIR}/.rbenv"
mkdir -p "$RBENV_ROOT"

pushd "$RBENV_ROOT" > /dev/null
    if [[ ! -d ".git" ]]; then
        git init --quiet
    fi
    if ! git remote get-url origin &>/dev/null; then
        git remote add origin https://github.com/rbenv/rbenv.git
    fi
    git fetch --depth 1 --quiet origin master || die "Failed to fetch rbenv"
    git checkout -B master origin/master --quiet || die "Failed to checkout rbenv master"
popd > /dev/null

export PATH="${RBENV_ROOT}/bin:$PATH"
export RBENV_ROOT

eval "$(rbenv init -)"
rbenv rehash

# Link TruffleRuby as an rbenv version
mkdir -p "${RBENV_ROOT}/versions"
if [[ -L "${RBENV_ROOT}/versions/truffleruby" ]]; then
    rm "${RBENV_ROOT}/versions/truffleruby"
fi
ln -s "$TRUFFLERUBY_HOME" "${RBENV_ROOT}/versions/truffleruby"
rbenv global truffleruby

log_step "Using TruffleRuby via rbenv"

# Install bundler and dependencies
if has_gemfile_lock "$BUILD_DIR"; then
    log_info "Installing Ruby dependencies"
    gem install bundler --no-document

    pushd "$BUILD_DIR" > /dev/null
        # Configure bundler for deployment
        bundle config set --local deployment true
        bundle config set --local without development:test
        bundle config set --local path vendor/bundle
        bundle install
    popd > /dev/null

    log_step "Dependencies installed successfully"
    exit 0
else
    log_warn "No Gemfile.lock found - skipping bundle install"
    exit 0
fi
